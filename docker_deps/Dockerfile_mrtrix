FROM python:3.12.1-bookworm AS builder

# Install build dependencies in a single layer
RUN apt-get -qq update \
    && apt-get install -yq --no-install-recommends \
    g++-11 \
    libeigen3-dev \
    libfftw3-dev \
    libgl1-mesa-dev \
    libpng-dev \
    libqt5opengl5-dev \
    libqt5svg5-dev \
    zlib1g-dev \
    git \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Set build arguments and environment variables
ARG CC=gcc-11 CXX=g++-11

WORKDIR /usr/local/mrtrix3

# Clone and build mrtrix with optimized settings
RUN git clone --branch 3.0.8 --depth 1 https://github.com/MRtrix3/mrtrix3.git . \
&& python3 ./configure \
&& python3 ./build -persistent -nopaginate \
&& rm -rf tmp

# Final stage
FROM debian:bookworm-slim

# Install runtime system dependencies.
RUN apt-get -qq update \
    && apt-get install -yq --no-install-recommends \
        binutils \
        dc \
        less \
        libfftw3-single3 \
        libfftw3-double3 \
        libgl1-mesa-glx \
        libgomp1 \
        liblapack3 \
        libpng16-16 \
        libqt5core5a \
        libqt5gui5 \
        libqt5network5 \
        libqt5svg5 \
        libqt5widgets5 \
        libtiff5-dev \
        python3 \
        python3-distutils \
        procps \
    && rm -rf /var/lib/apt/lists/*

# Copy only the necessary files from builder
COPY --from=builder /usr/local/mrtrix3 /usr/local/mrtrix3/build
